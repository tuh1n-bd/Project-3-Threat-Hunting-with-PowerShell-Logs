<dashboard version="1.1" theme="dark">
  <label>Threat Hunting: PowerShell Dashboard</label>
  <row>
    <panel>
      <title>1. KPI — Total PowerShell executions (last 24h)</title>
      <chart>
        <search>
          <query>index="ps_data" sourcetype="csv" CommandLine="*powershell*" earliest=-24h
| stats count AS total_ps_exec</query>
          <earliest>$earliest$</earliest>
          <latest>$latest$</latest>
        </search>
        <option name="charting.chart">radialGauge</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>2. Timechart — PowerShell executions over time</title>
      <chart>
        <search>
          <query>index="ps_data" sourcetype="csv" CommandLine="*powershell*" earliest=-7d
| timechart span=1h count</query>
          <earliest>$earliest$</earliest>
          <latest>$latest$</latest>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.drilldown">none</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>3. Suspicious flags detected</title>
      <table>
        <search>
          <query>index="ps_data" sourcetype="csv" CommandLine="*powershell*"
| eval suspicious_flags=if(match(CommandLine,"-nop|-w hidden|-noni|-executionpolicy bypass"),1,0)
| where suspicious_flags=1
| table _time, Account_Name, ComputerName, CommandLine</query>
          <earliest>$earliest$</earliest>
          <latest>$latest$</latest>
        </search>
        <option name="drilldown">cell</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>4. Base64-encoded PS executions</title>
      <table>
        <search>
          <query>index="ps_data" sourcetype="csv" (EventID=4104 OR EventID=4688) CommandLine="*powershell*"
| eval has_base64=if(match(CommandLine,"-enc|encode|frombase64string"),1,0)
| where has_base64=1
| table _time, Account_Name, ComputerName, CommandLine, Source_IP</query>
          <earliest>$earliest$</earliest>
          <latest>$latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>5. Top Accounts running PowerShell</title>
      <chart>
        <search>
          <query>index="ps_data" sourcetype="csv" CommandLine="*powershell*"
| stats count by Account_Name
| sort - count</query>
          <earliest>$earliest$</earliest>
          <latest>$latest$</latest>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.drilldown">none</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>6. Top Hosts running PowerShell</title>
      <chart>
        <search>
          <query>index="ps_data" sourcetype="csv" CommandLine="*powershell*"
| stats count by ComputerName
| sort - count</query>
          <earliest>$earliest$</earliest>
          <latest>$latest$</latest>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.drilldown">none</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>7. Rare PowerShell commands</title>
      <chart>
        <search>
          <query>index="ps_data" sourcetype="csv" CommandLine="*powershell*"
| rare CommandLine
| sort - count
| head 20</query>
          <earliest>$earliest$</earliest>
          <latest>$latest$</latest>
        </search>
        <option name="charting.chart">area</option>
        <option name="charting.drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
</dashboard>
